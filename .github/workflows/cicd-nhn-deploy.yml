name: CI/CD - NHN Deploy (file-group â†’ scenario)

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      BASE: ${{ secrets.NHN_API_BASE }}
      APPKEY: ${{ secrets.NHN_APPKEY }}
      PROJECT_ID: ${{ secrets.NHN_PROJECT_ID }}
      SERVER_GROUP_ID: ${{ secrets.NHN_SERVER_GROUP_ID }}
      SCENARIO_ID: ${{ secrets.NHN_SCENARIO_ID }}
      FILE_GROUP_NAME: ${{ secrets.NHN_FILE_GROUP_NAME }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Build (Gradle)
        run: |
          chmod +x ./gradlew
          ./gradlew clean bootJar --no-daemon

      - name: Find built JAR
        id: jar
        run: echo "path=$(ls -1 build/libs/*.jar | head -n1)" >> $GITHUB_OUTPUT

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1) íŒŒì¼ê·¸ë£¹ì— app.jar ì—…ë¡œë“œ (multipart/form-data)
      #    - ê¸°ì¡´ ë™ì¼íŒŒì¼ëª… ìˆìœ¼ë©´ ë®ì–´ì“°ê¸°(auto) ë˜ëŠ” ì‚­ì œ í›„ ì—…ë¡œë“œ
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload JAR to NHN Deploy File Group
        run: |
          set -euo pipefail
          JAR="${{ steps.jar.outputs.path }}"

          # (ì„ íƒ) ê¸°ì¡´ íŒŒì¼ ì‚­ì œ - íŒŒì¼ëª…ì´ app.jarë¡œ ê³ ì •ì´ë¼ë©´ ì•ˆì „í•˜ê²Œ ì§€ìš°ê³  ì—…ë¡œë“œ
          # curl -sS -X DELETE \
          #   -H "X-TC-APP-KEY: $APPKEY" \
          #   "$BASE/deploy/v1.0/projects/$PROJECT_ID/file-groups/$FILE_GROUP_NAME/files/app.jar" || true

          # ì—…ë¡œë“œ
          # â€» ì—”ë“œí¬ì¸íŠ¸/í—¤ë”ëŠ” í™˜ê²½ì— ë”°ë¼ v1.0/v1.1 ë“±ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ. 401/404 ì‹œ ë¬¸ì„œì˜ ê²½ë¡œë¥¼ í™•ì¸í•´ ì¡°ì •.
          curl -sS -X POST \
            -H "X-TC-APP-KEY: $APPKEY" \
            -H "Accept: application/json" \
            -F "file=@${JAR};filename=app.jar;type=application/java-archive" \
            "$BASE/deploy/v1.0/projects/$PROJECT_ID/file-groups/$FILE_GROUP_NAME/files"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2) ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰ (ì„œë²„ê·¸ë£¹ì— ëŒ€í•´ ì‹¤í–‰)
      #    - ì‹œë‚˜ë¦¬ì˜¤ ì•ˆì—ëŠ”: stop â†’ íŒŒì¼ë°°í¬(target=/opt/piuda) â†’ start
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Trigger Deploy Scenario (auto-discover)
        id: run_scn
        run: |
          set -euo pipefail

          # í›„ë³´ ì—”ë“œí¬ì¸íŠ¸ë“¤ (í™˜ê²½/ë²„ì „ì— ë”°ë¼ ë‹¬ë¼ì§)
          # ğŸ‘‰ ì‹¤ì œ ë„¤ BASE/PROJECT_ID/SCENARIO_ID/SERVER_GROUP_ID ë¡œ ë¬¸ìì—´ì´ ì™„ì„±ë¨
          CANDIDATE_PATHS=(
            "/deploy/v1.0/projects/$PROJECT_ID/scenarios/$SCENARIO_ID/executions"                          # ë°”ë””: {"serverGroupId":7036}
            "/deploy/v1.0/projects/$PROJECT_ID/scenarios/$SCENARIO_ID/executions?serverGroupId=$SERVER_GROUP_ID"
            "/deploy/v1/projects/$PROJECT_ID/scenarios/$SCENARIO_ID/executions"
            "/deploy/v1.0/projects/$PROJECT_ID/server-groups/$SERVER_GROUP_ID/scenarios/$SCENARIO_ID/executions"
            "/deploy/v1.0/projects/$PROJECT_ID/scenario-executions"                                        # ë°”ë””: {"scenarioId":..., "serverGroupId":...}
            "/deploy/api/v1/projects/$PROJECT_ID/scenarios/$SCENARIO_ID/executions"
          )

          # í›„ë³´ í—¤ë” í‚¤ (ê³„ì •/ë¦¬ì „ì— ë”°ë¼ ë‹¤ë¦„)
          declare -A HDRS
          HDRS["X-TC-APP-KEY"]="$APPKEY"
          HDRS["X-Api-Key"]="$APPKEY"
          HDRS["X-NHN-APP-KEY"]="$APPKEY"

          # ë°”ë”” íŒ¨í„´ í›„ë³´
          BODIES=(
            "{\"serverGroupId\": $SERVER_GROUP_ID}"
            "{\"scenarioId\": $SCENARIO_ID, \"serverGroupId\": $SERVER_GROUP_ID}"
            ""  # ë°”ë”” ì—†ì´ íŠ¸ë¦¬ê±°í•˜ëŠ” íƒ€ì…
          )

          RUN_ID=""
          USED_URL=""
          USED_HDR=""
          USED_BODY=""

          echo "== Preflight: try GET on each URL (405 íšŒí”¼ìš© ëª¨ì–‘ íŒŒì•…) =="
          for p in "${CANDIDATE_PATHS[@]}"; do
            URL="$BASE$p"
            echo "GET $URL"
            RESP_FILE=$(mktemp); HDR_FILE=$(mktemp)
            CODE=$(
              curl -sS -X GET "$URL" \
                -H "Accept: application/json" \
                -D "$HDR_FILE" -o "$RESP_FILE" -w "%{http_code}" || true
            )
            CT=$(grep -i '^content-type:' "$HDR_FILE" | head -n1 | tr -d '\r' || true)
            echo " -> HTTP $CODE | ${CT:-<no content-type>}"
            if [[ "$CODE" == "200" || "$CODE" == "404" || "$CODE" == "405" || "$CODE" == "401" || "$CODE" == "403" ]]; then
              # ë‹¨ìˆœíˆ ëª¨ì–‘ íŒŒì•…ìš© ì¶œë ¥
              :
            fi
          done

          echo "== Try POST with multiple endpoint/header/body combinations =="
          for p in "${CANDIDATE_PATHS[@]}"; do
            for k in "${!HDRS[@]}"; do
              for body in "${BODIES[@]}"; do
                URL="$BASE$p"
                echo "POST $URL with header $k and body='${body:0:60}â€¦'"
                RESP_FILE=$(mktemp); HDR_FILE=$(mktemp)
                ARGS=(-sS -X POST "$URL" -H "$k: ${HDRS[$k]}" -H "Accept: application/json")
                if [[ -n "$body" ]]; then
                  ARGS+=(-H "Content-Type: application/json" -d "$body")
                fi
                CODE=$(curl "${ARGS[@]}" -D "$HDR_FILE" -o "$RESP_FILE" -w "%{http_code}" || true)
                CT=$(grep -i '^content-type:' "$HDR_FILE" | head -n1 | tr -d '\r' || true)

                echo " -> HTTP $CODE | ${CT:-<no content-type>}"
                if [[ "$CODE" =~ ^2 ]]; then
                  # RUN_ID ì¶”ì¶œ
                  if echo "${CT,,}" | grep -q "application/json"; then
                    RID=$(jq -r '.executionId // .runId // .id // empty' < "$RESP_FILE" || true)
                  else
                    RID=$(grep -oE '[0-9a-fA-F\-]{6,}' "$RESP_FILE" | head -n1 || true)
                  fi

                  echo "Response body (truncated):"
                  head -c 400 "$RESP_FILE" || true
                  echo

                  if [[ -n "$RID" ]]; then
                    RUN_ID="$RID"; USED_URL="$URL"; USED_HDR="$k"; USED_BODY="$body"
                    echo "âœ… Success with $URL (header=$k)"
                    break 3
                  fi
                else
                  # ë¬¸ì œ íŒŒì•…ì— ë„ì›€ ë˜ë„ë¡ ìš”ì•½ ì¶œë ¥
                  echo "Headers:"; cat "$HDR_FILE" || true
                  echo "Body:"; head -c 400 "$RESP_FILE" || true; echo
                fi
              done
            done
          done

          if [[ -z "$RUN_ID" ]]; then
            echo "âŒ ëª¨ë“  ì¡°í•© ì‹¤íŒ¨. ìœ„ ë¡œê·¸ì˜ HTTP ì½”ë“œ/í—¤ë”/ë°”ë””ë¥¼ ë³´ê³ "
            echo "   - ì˜¬ë°”ë¥¸ ê²½ë¡œ: /deploy/v1.0/... vs /deploy/v1/... vs /deploy/api/v1/..."
            echo "   - ì˜¬ë°”ë¥¸ í—¤ë”: X-TC-APP-KEY vs X-Api-Key vs X-NHN-APP-KEY"
            echo "   - serverGroupId ì „ë‹¬: body / query / path"
            echo "   ì„ ë§ì¶°ì£¼ì„¸ìš”."
            exit 1
          fi

          echo "USED_URL=$USED_URL"
          echo "USED_HDR=$USED_HDR"
          echo "USED_BODY=$USED_BODY"
          echo "RUN_ID=$RUN_ID"
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "used_url=$USED_URL" >> $GITHUB_OUTPUT


      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3) ì‹¤í–‰ ìƒíƒœ í´ë§ (ì„±ê³µ/ì‹¤íŒ¨ ëŒ€ê¸°)
      #    - ìƒíƒœ í•„ë“œëŠ” status/state/result ë“± í™˜ê²½ë³„ ëª…ì¹­ì´ ë‹¤ë¥¼ ìˆ˜ ìˆì–´ ì•„ë˜ 3ê°€ì§€ë¥¼ ìˆœì„œë¡œ ì¡°íšŒ
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Wait for Scenario Result (robust)
        run: |
          set -euo pipefail
          RUN_ID="${{ steps.run_scn.outputs.run_id }}"
          URL="$BASE/deploy/v1.0/projects/$PROJECT_ID/scenarios/$SCENARIO_ID/executions/$RUN_ID"
          echo "Waiting scenario run: $RUN_ID"
          echo "GET $URL"

          for i in $(seq 1 60); do
            RESP_FILE=$(mktemp)
            HDR_FILE=$(mktemp)

            HTTP_CODE=$(
              curl -sS -X GET "$URL" \
                -H "X-TC-APP-KEY: $APPKEY" \
                -D "$HDR_FILE" \
                -o "$RESP_FILE" \
                -w "%{http_code}"
            )

            CT=$(grep -i '^content-type:' "$HDR_FILE" | head -n1 | tr -d '\r')
            echo "[$i] HTTP_CODE: $HTTP_CODE  Content-Type: ${CT:-<none>}"

            if echo "${CT,,}" | grep -q "application/json"; then
              # ìƒíƒœ í•„ë“œ í›„ë³´ë“¤
              STATUS=$(jq -r '.status // .state // .result // .executionStatus // empty' < "$RESP_FILE" || true)
              echo "[$i] STATUS(JSON): ${STATUS:-<empty>}"
            else
              echo "[$i] BODY:"
              cat "$RESP_FILE" || true
              echo
              # ë¹„JSONì´ë©´ ì‹¤íŒ¨ë¡œ ê°„ì£¼(ëª…í™•í•˜ê²Œ ì•Œê¸° ìœ„í•´)
              echo "âŒ ë¹„JSON ì‘ë‹µì…ë‹ˆë‹¤. ì—”ë“œí¬ì¸íŠ¸/í—¤ë”ë¥¼ ë¬¸ì„œì™€ ë§ì¶°ì£¼ì„¸ìš”."
              exit 1
            fi

            if [[ "$STATUS" =~ ^(SUCCESS|COMPLETED|DONE)$ ]]; then
              echo "âœ… Scenario SUCCESS"
              exit 0
            elif [[ "$STATUS" =~ ^(FAIL|FAILED|ERROR)$ ]]; then
              echo "âŒ Scenario FAILED"
              exit 1
            fi

            sleep 5
          done

          echo "â° Timeout waiting scenario result"
          exit 1
