name: CI/CD - NHN Deploy (v1 upload + v2 deploy)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      # ✅ NHN Deploy 공용 엔드포인트 (고정)
      BASE: https://api-tcd.nhncloudservice.com
      # ✅ Secrets 필요값 (콘솔 값과 정확히 일치)
      APPKEY: ${{ secrets.NHN_APPKEY }}            # Deploy 콘솔 AppKey
      ARTIFACT_ID: ${{ secrets.NHN_PROJECT_ID }}   # Deploy 콘솔 Artifact ID (숫자)
      SERVER_GROUP_ID: ${{ secrets.NHN_SERVER_GROUP_ID }}
      FILE_GROUP_NAME: ${{ secrets.NHN_FILE_GROUP_NAME }} # 콘솔 그룹 이름 (대/소문자 정확히)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Build (Gradle)
        run: |
          set -euo pipefail
          chmod +x ./gradlew
          ./gradlew clean bootJar --no-daemon

      - name: Find JAR
        id: jar
        run: |
          set -euo pipefail
          FILE=$(ls -1 build/libs/*.jar | head -n1)
          [ -n "$FILE" ] || { echo "❌ JAR not found under build/libs"; exit 1; }
          echo "path=$FILE" >> $GITHUB_OUTPUT
          echo "✅ JAR: $FILE"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # 1) (v1) Binary Group 목록 조회 → 이름으로 key 얻기
      - name: Resolve Binary Group Key (v1)
        id: bg
        run: |
          set -euo pipefail
          URL="$BASE/api/v1.0/projects/$APPKEY/artifacts/$ARTIFACT_ID/binary-group"
          echo "GET $URL"
          HTTP=$(curl -sS -w "%{http_code}" -o /tmp/bg.json "$URL" || true)
          echo "http=$HTTP"
          head -c 400 /tmp/bg.json || true; echo
          [ "$HTTP" = "200" ] || { echo "❌ binary-group 조회 실패 (HTTP $HTTP)"; exit 1; }
          jq -e '.' </tmp/bg.json >/dev/null || { echo "❌ JSON 아님"; exit 1; }
          KEY=$(jq -r --arg NAME "$FILE_GROUP_NAME" '.binaryGroups[]? | select(.name==$NAME) | .binaryGroupKey' </tmp/bg.json)
          [ -n "$KEY" ] && [ "$KEY" != "null" ] || { echo "❌ 그룹 '$FILE_GROUP_NAME' 없음 (콘솔에서 이름 정확히 확인)"; exit 1; }
          echo "key=$KEY" >> $GITHUB_OUTPUT
          echo "✅ binary-group key=$KEY"

      # 2) (v1) 해당 Binary Group에 JAR 업로드
      - name: Upload JAR to Binary Group (v1)
        id: upload
        env:
          BG_KEY: ${{ steps.bg.outputs.key }}
        run: |
          set -euo pipefail
          JAR="${{ steps.jar.outputs.path }}"
          URL="$BASE/api/v1.0/projects/$APPKEY/artifacts/$ARTIFACT_ID/binary-group/$BG_KEY"
          echo "POST $URL (file=$(basename "$JAR"))"
          HTTP=$(curl -sS -w "%{http_code}" -o /tmp/up.json \
            -X POST -F "file=@${JAR}" "$URL" || true)
          echo "http=$HTTP"
          head -c 400 /tmp/up.json || true; echo
          case "$HTTP" in
            200|201) echo "✅ 업로드 완료" ;;
            *) echo "❌ 업로드 실패 (HTTP $HTTP)"; exit 1 ;;
          esac

      # 3) (v2) 서버그룹 배포 트리거
      - name: Deploy (v2)
        run: |
          set -euo pipefail
          URL="$BASE/api/v2.0/projects/$APPKEY/artifacts/$ARTIFACT_ID/server-group/$SERVER_GROUP_ID/deploy"
          echo "POST $URL"
          HTTP=$(curl -sS -w "%{http_code}" -o /tmp/deploy.json -X POST "$URL" || true)
          echo "http=$HTTP"
          head -c 400 /tmp/deploy.json || true; echo
          case "$HTTP" in
            200|202) echo "✅ 배포 트리거 완료" ;;
            *) echo "❌ 배포 트리거 실패 (HTTP $HTTP)"; exit 1 ;;
          esac
