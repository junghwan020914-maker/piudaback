name: CI/CD - NHN Deploy API (v1 upload + v2 deploy)

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      # ✅ 정식 엔드포인트
      BASE: https://api-tcd.nhncloudservice.com
      APPKEY: ${{ secrets.NHN_APPKEY }}           # Deploy 콘솔의 AppKey
      ARTIFACT_ID: ${{ secrets.NHN_PROJECT_ID }}  # = artifactId (이름 혼동 주의)
      SERVER_GROUP_ID: ${{ secrets.NHN_SERVER_GROUP_ID }}
      FILE_GROUP_NAME: ${{ secrets.NHN_FILE_GROUP_NAME }}  # 콘솔의 Binary Group 이름

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Build (Gradle)
        run: |
          chmod +x ./gradlew
          ./gradlew clean bootJar --no-daemon

      - name: Find JAR
        id: jar
        run: echo "path=$(ls -1 build/libs/*.jar | head -n1)" >> $GITHUB_OUTPUT

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # === v1: Binary Group 목록에서 NAME→KEY 해석 ===
      - name: Resolve Binary Group Key by name (v1)
        id: bg
        run: |
          set -euo pipefail
          RESP=$(curl -sS "$BASE/api/v1.0/projects/$APPKEY/artifacts/$ARTIFACT_ID/binary-group")
          echo "$RESP" | jq -r '.'
          BG_KEY=$(echo "$RESP" | jq -r --arg NAME "$FILE_GROUP_NAME" '.binaryGroups[] | select(.name==$NAME) | .binaryGroupKey')
          if [ -z "$BG_KEY" ] || [ "$BG_KEY" = "null" ]; then
            echo "❌ Binary Group not found: $FILE_GROUP_NAME"
            exit 1
          fi
          echo "key=$BG_KEY" >> $GITHUB_OUTPUT

      # === v1: 바이너리 업로드 ===
      - name: Upload JAR to Binary Group (v1)
        id: upload
        env:
          BG_KEY: ${{ steps.bg.outputs.key }}
        run: |
          JAR="${{ steps.jar.outputs.path }}"
          RESP=$(curl -sS -X POST \
            "$BASE/api/v1.0/projects/$APPKEY/artifacts/$ARTIFACT_ID/binary-group/$BG_KEY" \
            -F "file=@${JAR}")
          echo "$RESP" | jq -r '.'

      # === v2: 배포 실행 ===
      - name: Deploy (v2)
        id: deploy
        run: |
          RESP=$(curl -sS -X POST \
            "$BASE/api/v2.0/projects/$APPKEY/artifacts/$ARTIFACT_ID/server-group/$SERVER_GROUP_ID/deploy")
          echo "$RESP" | jq -r '.'
          # v2는 2024~25 문서 기준, 본 호출 자체가 트리거입니다.

