name: CI/CD - NHN Deploy (file-group → scenario)

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      BASE: ${{ secrets.NHN_API_BASE }}
      APPKEY: ${{ secrets.NHN_APPKEY }}
      PROJECT_ID: ${{ secrets.NHN_PROJECT_ID }}
      SERVER_GROUP_ID: ${{ secrets.NHN_SERVER_GROUP_ID }}
      SCENARIO_ID: ${{ secrets.NHN_SCENARIO_ID }}
      FILE_GROUP_NAME: ${{ secrets.NHN_FILE_GROUP_NAME }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Build (Gradle)
        run: |
          chmod +x ./gradlew
          ./gradlew clean bootJar --no-daemon

      - name: Find built JAR
        id: jar
        run: echo "path=$(ls -1 build/libs/*.jar | head -n1)" >> $GITHUB_OUTPUT

      # ─────────────────────────────────────────
      # 1) 파일그룹에 app.jar 업로드 (multipart/form-data)
      #    - 기존 동일파일명 있으면 덮어쓰기(auto) 또는 삭제 후 업로드
      # ─────────────────────────────────────────
      - name: Upload JAR to NHN Deploy File Group (header project-id)
        run: |
          set -euo pipefail
          JAR="${{ steps.jar.outputs.path }}"
          URL="$BASE/deploy/v1.0/file-groups/$FILE_GROUP_NAME/files"

          echo "POST $URL"
          RESP_FILE=$(mktemp); HDR_FILE=$(mktemp)
          CODE=$(
            curl -sS -X POST "$URL" \
              -H "X-TC-APP-KEY: $APPKEY" \
              -H "X-Project-Id: $PROJECT_ID" \
              -H "Accept: application/json" \
              -F "file=@${JAR};filename=app.jar;type=application/java-archive" \
              -D "$HDR_FILE" -o "$RESP_FILE" -w "%{http_code}" || true
          )
          echo "HTTP_CODE: $CODE"
          echo "---- RESPONSE HEADERS ----"; cat "$HDR_FILE"
          echo "---- RESPONSE BODY (raw) ----"; head -c 400 "$RESP_FILE" || true; echo

          if [[ ! "$CODE" =~ ^2 ]]; then
            echo "❌ Upload failed"
            exit 1
          fi

      # ─────────────────────────────────────────
      # 2) 시나리오 실행 (서버그룹에 대해 실행)
      #    - 시나리오 안에는: stop → 파일배포(target=/opt/piuda) → start
      # ─────────────────────────────────────────
      - name: Trigger Deploy Scenario (with X-Project-Id)
        id: run_scn
        run: |
          set -euo pipefail
          URL="$BASE/deploy/v1.0/scenarios/$SCENARIO_ID/executions"
          BODY="{\"serverGroupId\": $SERVER_GROUP_ID}"

          echo "POST $URL"
          RESP_FILE=$(mktemp); HDR_FILE=$(mktemp)
          CODE=$(
            curl -sS -X POST "$URL" \
              -H "X-TC-APP-KEY: $APPKEY" \
              -H "X-Project-Id: $PROJECT_ID" \
              -H "Content-Type: application/json" \
              -H "Accept: application/json" \
              -d "$BODY" \
              -D "$HDR_FILE" -o "$RESP_FILE" -w "%{http_code}" || true
          )

          echo "HTTP_CODE: $CODE"
          echo "---- RESPONSE HEADERS ----"; cat "$HDR_FILE"
          echo "---- RESPONSE BODY (raw) ----"; head -c 400 "$RESP_FILE" || true; echo

          if [[ ! "$CODE" =~ ^2 ]]; then
            echo "❌ Scenario trigger failed"
            exit 1
          fi

          # 실행 ID 추출(executionId/runId/id 대응)
          RUN_ID="$(jq -r '.executionId // .runId // .id // empty' < "$RESP_FILE" || true)"
          if [[ -z "$RUN_ID" ]]; then
            # 비JSON일 가능성 대비
            RUN_ID="$(grep -oE '[0-9a-fA-F\-]{6,}' "$RESP_FILE" | head -n1 || true)"
          fi
          if [[ -z "$RUN_ID" ]]; then
            echo "❌ RUN_ID not found"
            exit 1
          fi
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT


      # ─────────────────────────────────────────
      # 3) 실행 상태 폴링 (성공/실패 대기)
      #    - 상태 필드는 status/state/result 등 환경별 명칭이 다를 수 있어 아래 3가지를 순서로 조회
      # ─────────────────────────────────────────
      - name: Wait for Scenario Result (with X-Project-Id)
        run: |
          set -euo pipefail
          RUN_ID="${{ steps.run_scn.outputs.run_id }}"
          URL="$BASE/deploy/v1.0/scenarios/$SCENARIO_ID/executions/$RUN_ID"
          echo "GET $URL"

          for i in $(seq 1 60); do
            RESP_FILE=$(mktemp); HDR_FILE=$(mktemp)
            CODE=$(
              curl -sS -X GET "$URL" \
                -H "X-TC-APP-KEY: $APPKEY" \
                -H "X-Project-Id: $PROJECT_ID" \
                -H "Accept: application/json" \
                -D "$HDR_FILE" -o "$RESP_FILE" -w "%{http_code}" || true
            )
            CT=$(grep -i '^content-type:' "$HDR_FILE" | head -n1 | tr -d '\r' || true)
            echo "[$i] HTTP_CODE: $CODE | ${CT:-<none>}"

            if [[ ! "$CODE" =~ ^2 ]]; then
              echo "Headers:"; cat "$HDR_FILE"; echo "Body:"; head -c 400 "$RESP_FILE"; echo
              exit 1
            fi

            STATUS=$(jq -r '.status // .state // .result // .executionStatus // empty' < "$RESP_FILE" || true)
            echo "[$i] STATUS: ${STATUS:-<empty>}"

            if [[ "$STATUS" =~ ^(SUCCESS|COMPLETED|DONE)$ ]]; then
              echo "✅ Scenario SUCCESS"
              exit 0
            elif [[ "$STATUS" =~ ^(FAIL|FAILED|ERROR)$ ]]; then
              echo "❌ Scenario FAILED"
              exit 1
            fi
            sleep 5
          done

          echo "⏰ Timeout"
          exit 1
